# Test Suite for Advanced Medical Reward

æœ¬ç›®å½•åŒ…å«æ‰€æœ‰ç”¨äºéªŒè¯Advanced Rewardå®ç°çš„æµ‹è¯•è„šæœ¬ã€‚

## ğŸ“ æ–‡ä»¶è¯´æ˜

### `test_full_integration.py`
ç»¼åˆé›†æˆæµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š
- âœ“ æ¨¡å—å¯¼å…¥
- âœ“ Rewardè®¡ç®—ï¼ˆå¤šä¸ªåœºæ™¯ï¼‰
- âœ“ å¯è®­ç»ƒæƒé‡æ¨¡å—
- âœ“ ä¸GRPOçš„å…¼å®¹æ€§

**è¿è¡Œæ–¹å¼ï¼š**
```bash
python test/test_full_integration.py
```

### `test_reward_integration.py`
å•å…ƒæµ‹è¯•è„šæœ¬ï¼Œé‡ç‚¹æµ‹è¯•rewardè®¡ç®—çš„æ­£ç¡®æ€§ï¼š
- âœ“ å®Œå…¨ç›¸åŒæ–‡æœ¬ (reward = 1.0)
- âœ“ å°å¹…ä¿®æ”¹
- âœ“ å‰‚é‡æ”¹å˜ï¼ˆåŒ»å­¦ç‰¹å®šï¼‰
- âœ“ ç©ºæ–‡æœ¬å¤„ç†
- âœ“ åŒ»å­¦æ–‡æœ¬ï¼ˆä¸­æ–‡ï¼‰

**è¿è¡Œæ–¹å¼ï¼š**
```bash
python test/test_reward_integration.py
```

## ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•

### æ–¹å¼1ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
bash run_setup_and_test.sh
```

è¿™ä¼šè‡ªåŠ¨ï¼š
1. æ£€æŸ¥Pythonç¯å¢ƒ
2. å®‰è£…/æ›´æ–°ä¾èµ–
3. è¿è¡Œæ‰€æœ‰æµ‹è¯•
4. è¾“å‡ºæµ‹è¯•ç»“æœå’Œå»ºè®®

### æ–¹å¼2ï¼šé€ä¸ªè¿è¡Œæµ‹è¯•
```bash
cd /home/gujing/zzq/Aiedu

# è¿è¡Œç»¼åˆæµ‹è¯•ï¼ˆé¦–é€‰ï¼‰
python test/test_full_integration.py

# è¿è¡Œå•å…ƒæµ‹è¯•
python test/test_reward_integration.py
```

### æ–¹å¼3ï¼šä½¿ç”¨pytestï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest test/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest test/test_full_integration.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest test/test_full_integration.py::test_imports -v
```

## âœ… æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•åº”è¯¥è¾“å‡ºç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼š

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           Rewardå®ç°ç»¼åˆæµ‹è¯•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æµ‹è¯•1ï¼šæ¨¡å—å¯¼å…¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ Rewardç›¸å…³æ¨¡å—å¯¼å…¥æˆåŠŸ

æµ‹è¯•2ï¼šRewardè®¡ç®—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æµ‹è¯•ç”¨ä¾‹ 1: å®Œå…¨ç›¸åŒæ–‡æœ¬
  åŸæ–‡: Patient takes 10mg aspirin daily.
  ä¿®æ”¹: Patient takes 10mg aspirin daily.
  Basic Reward: 1.0000
  Advanced Reward: 1.0000
  âœ“ é€šè¿‡

[... æ›´å¤šæµ‹è¯•ç”¨ä¾‹ ...]

æµ‹è¯•æ€»ç»“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¯¼å…¥æµ‹è¯•..................................... âœ“ é€šè¿‡
Rewardè®¡ç®—.................................. âœ“ é€šè¿‡
å¯è®­ç»ƒæƒé‡.................................. âœ“ é€šè¿‡
å‡½æ•°ç­¾åæ£€æŸ¥................................. âœ“ é€šè¿‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¯ä»¥ä»main.pyå¼€å§‹è¿è¡Œæ•´ä¸ªæµç¨‹ã€‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ” æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. å¯¼å…¥æµ‹è¯•
éªŒè¯æ‰€æœ‰å¿…è¦æ¨¡å—å¯ä»¥æ­£ç¡®å¯¼å…¥ï¼š
- `utils.reward` - Rewardè®¡ç®—æ¨¡å—
- `utils.reward_new` - æ–°çš„Advancedå®ç°
- æ‰€æœ‰å…³é”®ç±»å’Œå‡½æ•°

### 2. Rewardè®¡ç®—æµ‹è¯•
æµ‹è¯•å„ç§åœºæ™¯ä¸‹çš„rewardå€¼ï¼š
- **å®Œå…¨ç›¸åŒæ–‡æœ¬** - åº”è¿”å›1.0
- **å°å¹…ä¿®æ”¹** - åº”è¿”å›0.5-1.0ä¹‹é—´
- **å‰‚é‡æ”¹å˜** - åº”è¿”å›0.4-0.9ä¹‹é—´
- **ç©ºæ–‡æœ¬** - åº”è¿”å›<0.1
- **åŒ»å­¦æ–‡æœ¬** - å¯¹åŒ»å­¦æ”¹å˜æ•æ„Ÿ

### 3. å¯è®­ç»ƒæƒé‡æµ‹è¯•
éªŒè¯TrainableRewardWeightsæ¨¡å—ï¼š
- âœ“ æ¨¡å—åˆ›å»º
- âœ“ Forward pass
- âœ“ æƒé‡è·å–
- âœ“ æƒé‡å½’ä¸€åŒ–

### 4. å…¼å®¹æ€§æµ‹è¯•
éªŒè¯ä¸GRPOçš„é›†æˆå…¼å®¹æ€§ï¼š
- âœ“ å‡½æ•°ç­¾åæ­£ç¡®
- âœ“ å‚æ•°å®Œæ•´
- âœ“ è¿”å›å€¼ç±»å‹æ­£ç¡®

## ğŸ› è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# æ·»åŠ æ—¥å¿—è¾“å‡º
python -c "import logging; logging.basicConfig(level=logging.DEBUG); exec(open('test/test_full_integration.py').read())"
```

### æ£€æŸ¥ç‰¹å®šæ¨¡å—
```bash
# æ£€æŸ¥rewardæ¨¡å—
python -c "from utils.reward import compute_advanced_reward; print('OK')"

# æ£€æŸ¥reward_newæ¨¡å—
python -c "from utils.reward_new import TrainableRewardWeights; print('OK')"

# æ£€æŸ¥æ‰€æœ‰ä¾èµ–
python -c "import torch; import transformers; import bert_score; print('All dependencies OK')"
```

### è¿è¡Œå•ä¸ªæµ‹è¯•å‡½æ•°
```bash
# ç¼–è¾‘test_full_integration.pyï¼Œç„¶åç›´æ¥è°ƒç”¨å‡½æ•°
python -c "
import sys
sys.path.insert(0, '.')
from test.test_full_integration import test_imports
test_imports()
"
```

## ğŸ“Š æ€§èƒ½åŸºå‡†

åœ¨RTX 3090 GPUä¸Šçš„æµ‹è¯•ç»“æœï¼š

| æµ‹è¯•é¡¹ | æ—¶é—´ | å†…å­˜ |
|--------|------|------|
| æ¨¡å—å¯¼å…¥ | ~5ç§’ | ~500MB |
| Rewardè®¡ç®—ï¼ˆå•ä¸ªï¼‰ | 200-500ms | ~300MB |
| 4ä¸ªrewardè®¡ç®— | ~1-2ç§’ | ~400MB |
| å¯è®­ç»ƒæƒé‡åˆ›å»º | ~100ms | ~50MB |

## âœ¨ æœ€ä½³å®è·µ

1. **é¦–æ¬¡è¿è¡Œå‰**
   ```bash
   pip install -r requirements.txt
   ```

2. **éªŒè¯å®‰è£…**
   ```bash
   bash run_setup_and_test.sh
   ```

3. **å®šæœŸè¿è¡Œæµ‹è¯•**
   ```bash
   # åœ¨ä¿®æ”¹ä»£ç å
   python test/test_full_integration.py
   ```

4. **é›†æˆCI/CD**
   ```bash
   # å¯åœ¨GitHub Actionsç­‰ä¸­è¿è¡Œ
   python -m pytest test/ -v
   ```

## ğŸ“ å¸¸è§é—®é¢˜

**Q: æµ‹è¯•è¿è¡Œè¶…æ—¶ï¼Ÿ**
A: BertScoreé¦–æ¬¡è¿è¡Œä¼šä¸‹è½½RobertaLargeæ¨¡å‹ï¼ˆ~120ç§’ï¼‰ï¼Œåç»­è¿è¡Œä¼šå¿«å¾—å¤šã€‚

**Q: æ˜¾å­˜ä¸è¶³ï¼Ÿ**
A: è¿™æ˜¯BertScoreçš„RobertaLargeæ¨¡å‹éœ€è¦çš„ã€‚å¦‚éœ€å‡å°‘æ˜¾å­˜ï¼Œå¯æ”¹ç”¨è½»é‡æ¨¡å‹ã€‚

**Q: ImportError: No module named 'xxx'ï¼Ÿ**
A: è¿è¡Œ `pip install -r requirements.txt` å®‰è£…æ‰€æœ‰ä¾èµ–ã€‚

**Q: èƒ½å¦è·³è¿‡æŸäº›æµ‹è¯•ï¼Ÿ**
A: å¯ä»¥ç¼–è¾‘æµ‹è¯•æ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ä¸éœ€è¦çš„æµ‹è¯•å‡½æ•°ã€‚

## ğŸ”„ æŒç»­æ”¹è¿›

æ¬¢è¿æäº¤æ”¹è¿›å»ºè®®ï¼š
- æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹
- æ›´å…¨é¢çš„åŒ»å­¦å®ä½“è¦†ç›–
- æ€§èƒ½ä¼˜åŒ–
- æ–‡æ¡£æ”¹è¿›

---

**æœ€åæ›´æ–°:** 2024-12-23  
**çŠ¶æ€:** âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
